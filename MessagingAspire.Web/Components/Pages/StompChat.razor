@page "/stomp-chat"
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>STOMP Chat</PageTitle>

<h1>RabbitMQ STOMP WebSocket Chat</h1>

<div class="chat-container">
    <div class="connection-status mb-3">
        <span class="badge @(isConnected ? "bg-success" : "bg-danger")">
            @(isConnected ? "Connected" : "Disconnected")
        </span>
        <small class="ms-2">@statusMessage</small>
    </div>

    <div class="card mb-3">
        <div class="card-body" style="height: 400px; overflow-y: auto;" id="messagesContainer">
            @foreach (var msg in messages)
            {
                <div class="message-item mb-2 p-2 @(msg.IsSystem ? "bg-light" : "bg-white") border rounded">
                    <strong class="@(msg.IsSystem ? "text-muted" : "text-primary")">@msg.User</strong>
                    <small class="text-muted">@msg.Timestamp.ToLocalTime().ToString("HH:mm:ss")</small>
                    <div>@msg.Text</div>
                </div>
            }
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            @if (!isConnected)
            {
                <div class="mb-3">
                    <label for="username" class="form-label">Your Name:</label>
                    <input type="text" class="form-control" id="username" @bind="userName" placeholder="Enter your name" />
                </div>
                <div class="mb-3">
                    <label for="stompUrl" class="form-label">STOMP WebSocket URL:</label>
                    <input type="text" class="form-control" id="stompUrl" @bind="stompUrl" placeholder="ws://localhost:15674/ws" />
                    <small class="form-text text-muted">Default RabbitMQ STOMP WebSocket port is 15674</small>
                </div>
                <button class="btn btn-success" @onclick="ConnectToStomp">Connect to STOMP</button>
            }
            else
            {
                <div class="input-group mb-3">
                    <input type="text" class="form-control" @bind="messageText" 
                           @bind:event="oninput"
                           @onkeydown="HandleKeyDown"
                           placeholder="Type a message..." />
                    <button class="btn btn-primary" @onclick="SendMessage" disabled="@string.IsNullOrWhiteSpace(messageText)">
                        Send
                    </button>
                </div>
                <button class="btn btn-danger btn-sm" @onclick="DisconnectFromStomp">Disconnect</button>
            }
        </div>
    </div>
</div>

@code {
    private List<Message> messages = new();
    private string userName = "User";
    private string messageText = "";
    private string stompUrl = "ws://localhost:15674/ws";
    private string stompLogin = "guest";
    private string stompPasscode = "guest";
    private string stompVHost = "/";
    private string statusMessage = "Loading configuration...";
    private bool isConnected = false;
    private DotNetObjectReference<StompChat>? objRef;

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        
        // Load RabbitMQ WebSocket URL from configuration
        try
        {
            var baseUri = Navigation.BaseUri.TrimEnd('/');
            var configUrl = $"{baseUri}/api/rabbitmq-config";
            
            using var httpClient = new HttpClient();
            var response = await httpClient.GetFromJsonAsync<RabbitMQConfig>(configUrl);

            if (response != null)
            {
                if (!string.IsNullOrEmpty(response.StompUrl))
                    stompUrl = response.StompUrl;
                if (!string.IsNullOrEmpty(response.Login))
                    stompLogin = response.Login;
                if (!string.IsNullOrEmpty(response.Passcode))
                    stompPasscode = response.Passcode;
                if (!string.IsNullOrEmpty(response.VHost))
                    stompVHost = response.VHost;
                statusMessage = "Ready to connect";
            }
            else
            {
                statusMessage = "Using default configuration";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Config load failed, using defaults: {ex.Message}";
        }
    }

    private async Task ConnectToStomp()
    {
        try
        {
            statusMessage = "Connecting...";
            StateHasChanged();

            await JS.InvokeVoidAsync("stompClient.connect", objRef, stompUrl, userName, stompLogin, stompPasscode, stompVHost);
        }
        catch (Exception ex)
        {
            statusMessage = $"Connection failed: {ex.Message}";
            AddSystemMessage($"Failed to connect: {ex.Message}");
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        isConnected = true;
        statusMessage = "Connected to STOMP server";
        AddSystemMessage("Successfully connected to STOMP server");
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected()
    {
        isConnected = false;
        statusMessage = "Disconnected from STOMP server";
        AddSystemMessage("Disconnected from STOMP server");
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnMessageReceived(string user, string text, string timestamp)
    {
        messages.Add(new Message
        {
            User = user,
            Text = text,
            Timestamp = DateTime.Parse(timestamp),
            IsSystem = false
        });
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnError(string error)
    {
        statusMessage = $"Error: {error}";
        AddSystemMessage($"Error: {error}");
        InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageText) || !isConnected)
            return;

        try
        {
            await JS.InvokeVoidAsync("stompClient.sendMessage", messageText);
            messageText = "";
        }
        catch (Exception ex)
        {
            AddSystemMessage($"Failed to send message: {ex.Message}");
        }
    }

    private async Task DisconnectFromStomp()
    {
        try
        {
            await JS.InvokeVoidAsync("stompClient.disconnect");
        }
        catch (Exception ex)
        {
            AddSystemMessage($"Disconnect error: {ex.Message}");
        }
    }

    private void AddSystemMessage(string text)
    {
        messages.Add(new Message
        {
            User = "System",
            Text = text,
            Timestamp = DateTime.Now,
            IsSystem = true
        });
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(messageText))
        {
            await SendMessage();
        }
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }

    private class Message
    {
        public string User { get; set; } = "";
        public string Text { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public bool IsSystem { get; set; }
    }

    private class RabbitMQConfig
    {
        public string StompUrl { get; set; } = "";
        public string Login { get; set; } = "";
        public string Passcode { get; set; } = "";
        public string VHost { get; set; } = "/";
    }
}
